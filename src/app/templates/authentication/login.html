{% extends "base.html" %}
{% block title %}Add Donation{% endblock %}
{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', path='assets/css/plugins/slider-range.css') }}" />

{% endblock %}

{% block content %}
<!-- background-image: url(https://images.unsplash.com/photo-1553787434-45e1d245bfbb?q=80&w=1420&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D); -->
<!-- <main class="main page" style="padding-left: 50px;padding-right:50px;padding-top:10px;">
    <h2  style="text-align: center;">Sign In</h2>
    <h5 style="text-align: center;">Dont have an account? <a href="/authentication/signup"> Sign Up </a></h5>
    <form  id="signin_form">
        method="POST" action="/authentication/sigin" 
        <div class="row">
            <div class="col-6">
                <div class="mb-3">
                    <label for="name" class="form-label">Username</label>
                    <input type="text" class="form-control is_valid" id="name" aria-describedby="usernameHelp" name="name" >
                    <div id="emailHelp" class="form-text">We'll never share your email with anyone else.</div>
                </div>
            </div>
            <div class="col-6">
                <div class="mb-3">
                    <label for="password" class="form-label">Password</label>
                    <input type="password" class="form-control" id="password" name="password">
                </div>
            </div>
            <div class="col-12" style="text-align: right;">
                <div class="col-lg-4 col-md-12 col-sm-12">
                    <div class="form-group " >
                        <button type="submit" class="btn btn-primary " >Sign In</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row" >
            <div class="col-5">
                <div style="border-top:2px solid lightgrey;width: 100%;">
            </div>
            </div>
            <div class="col-2" >
                <h6 class="text" style="text-align: center;">Social Sign In</h6>
            </div>
            <div class="col-5">
                <div style="border-top:2px solid lightgrey;width: 100%;">
            </div>
            </div>
        </div>
        </br>
        <div  style="text-align: center;">
            <button class="btn btn-lg btn-block btn-primary" style="background-color: #dd4b39;"type="submit"><i class="fab fa-google me-2"></i> Google</button>
            <button class="btn btn-lg btn-block btn-primary" style="background-color: #397bdd;"type="submit"><i class="fab fa-facebook me-2"></i> Facebook</button>
        </div>
    </form>
</main> -->
<main>
    <div class="page-content pt-100 pb-100">
        <div class="container">
            <div class="row">
                <div class="col-xl-8 col-lg-10 col-md-12 m-auto">
                    <div class="row">
                        <div class="col-lg-6 pr-30 d-none d-lg-block">
                            <img class="border-radius-15" src="{{ url_for('static', path='assets/imgs/page/login-1.png') }}" alt="" />
                            
                        </div>
                        <div class="col-lg-6 col-md-8">
                            <div class="login_wrap widget-taber-content background-white">
                                <div class="padding_eight_all bg-white">
                                    <div class="heading_s1">
                                        <h1 class="mb-5">Login</h1>
                                        <p class="mb-30">Don't have an account? <a href="/register">Register Here</a></p>
                                    </div>
                                    <form id="signin_form">
                                        <div class="mb-3">
                                            <input type="text"  id="name" name="name" placeholder="Username" />
                                        </div>
                                        <div class="mb-3">
                                            <input  type="password" id="password" name="password" placeholder="Your password *" />
                                        </div>
                                        <!-- <div class="login_footer mb-3">
                                            <div class="chek-form">
                                                <input type="text" id="code" name="code" placeholder="Confirmation code *" />
                                            </div>
                                            <div class="form-group">
                                                <button type="button" class="btn btn-heading btn-block" name="login">Resend</button>
                                            </div>
                                        </div> -->
                                        <div class="login_footer form-group mb-50">
                                            <div class="form-group">
                                            <button type="submit" class="btn btn-heading btn-block hover-up" name="login">Log in</button>
                                        </div>
                                            <!-- <div class="chek-form">
                                                <div class="custome-checkbox">
                                                    <input class="form-check-input" type="checkbox" name="checkbox" id="exampleCheckbox1" value="" />
                                                    <label class="form-check-label" for="exampleCheckbox1"><span>Remember me</span></label>
                                                </div>
                                            </div> -->
                                            <a class="text-muted" href="#">Forgot password?</a>
                                        </div>
                                        
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        document.getElementById("signin_form").addEventListener("submit", function(event) {
            event.preventDefault();

            var mfa = ""

            // Show loader
            const loadingDiv = document.getElementById('loadingDiv');
            loadingDiv.style.display = "block";

            const formData = {
                Name: document.getElementById("name").value,
                Password: document.getElementById("password").value,
            };
        
            console.log("fetching api")
            // Start: Send form data using Fetch API
            fetch("/login", {
                method: "POST",
                body: JSON.stringify(formData),
                headers: {
                    "Content-Type": "application/json",
                },
            })
            .then(response => response.json())
            .then(data => {
                console.log("redirecting")
                console.log(data)
                
                // Hide loader
                // loadingDiv.style.display = 'none';

                // Check for status of Login
                if(data.status === "success"){
                    console.log("success")
                    // Extract the redirect URL from the JSON response
                    const redirectUrl = data.redirect_url;
                    if(data.mfa === "Enabled"){
                        mfa = "Enabled"
                        
                        mfaCode(data.name,data.password)
                        // Hide loader
                        loadingDiv.style.display = "none";

                    }else if(data.mfa === "Disabled"){
                        mfa = "Disabled"
                        // Set item in local to display message in next page
                        localStorage.setItem("action","success_login")

                        // Redirect to the extracted URL
                        window.location.href = data.redirectUrl;

                        // Hide loader
                        loadingDiv.style.display = "none";
                    }

                } else if(data.status === "fail"){
                    console.log("fail")
                    
                    // Hide loader
                    loadingDiv.style.display = "none";

                    // Display Error notification if authentication fails
                    Swal.fire({
                        icon: "error",
                        title: "Oops...",
                        confirmButtonColor:"#3BB77E",
                        text: "Invalid username or password, Please try again",
                        // footer: '<a href="#">Why do I have this issue?</a>'
                    });
                }

                
            })
            .catch(error => {
                console.error("Error:", error);
               
            });
            // End: Send form data using Fetch API
            
            // if(mfa === "Enabled"){
            //     // Shows a pop up of qr code to scan & enter code generated by Google Auth
            //     Swal.fire({
            //         title: "",
            //         text: "Google Authentication",
            //         allowOutsideClick: false,
            //         input: "text",
            //         inputPlaceholder: "Enter your code here",
            //         inputAttributes: {
            //             maxlength: "10",
            //             autocapitalize: "off",
            //             autocorrect: "off"
            //         },
            //         preConfirm: (value) => {
            //             return value
            //         }

            //     })
            //     .then((result) => {

            //         // Show loader
            //         loadingDiv.style.display = "";
                    
            //         console.log("Starting Auth Code");
            //         // Verify code with Cognito
            //         console.log(result.value)
            //         mfaAuthCode(result.value)
            //         console.log("Finish Auth Code");

            //         // Hide loader
            //         loadingDiv.style.display = "none";
            //     })
            // }

        })


    })

    function mfaAuthCode(name,password,code){
        // Data to send in the post request
        const formData = {Name:name,Password:password,Code:code};

        // Verify code with Cognito
        fetch("/login/mfa", {
            method: "POST",
            body: JSON.stringify(formData),
            headers: {
                "Content-Type": "application/json",
            },
        })
        .then(response => response.json())
        .then(data => {
            // If code is correct
            if(data.status === "success"){

                // Show loader
                loadingDiv.style.display = "";

                console.log("code pass")
               // Set item in local to display message in next page
                localStorage.setItem("action","success_login")

                // Redirect to the extracted URL
                window.location.href = data.redirect_url ;

                // Hide loader
                // loadingDiv.style.display = "";

            // If code is incorrect
            }else if(data.status === "fail"){
                console.log("code fail")
                // Hide loader
                loadingDiv.style.display = "none";

                // Re enter code
                mfaCodeFail(name,password)
            }
        })
    };

    function mfaCode(name,password){
        
        Swal.fire({
            title: "",
            text: "Google Authentication",
            allowOutsideClick: false,
            input: "text",
            inputPlaceholder: "Enter your code here",
            inputAttributes: {
                maxlength: "10",
                autocapitalize: "off",
                autocorrect: "off"
            },
            preConfirm: (value) => {
                return value
            }

        })
        .then((result) => {

            // Show loader
            loadingDiv.style.display = "";
            
            console.log("Starting Auth Code");
            // Verify code with Cognito
            mfaAuthCode(name,password,result.value)
            console.log("Finish Auth Code");

            // Hide loader
            loadingDiv.style.display = "none";
        })
    }

    function mfaCodeFail(name,password){
        
        Swal.fire({
            icon: "error",
            title: "Google Authentication",
            text: "Invalid Code, Please try again",
            allowOutsideClick: false,
            input: "text",
            inputPlaceholder: "Enter your code here",
            inputAttributes: {
                maxlength: "10",
                autocapitalize: "off",
                autocorrect: "off"
            },
            preConfirm: (value) => {
                return value
            }

        })
        .then((result) => {

            // Show loader
            loadingDiv.style.display = "";
            
            console.log("Starting Auth Code");
            // Verify code with Cognito
            mfaAuthCode(name,password,result.value)
            console.log("Finish Auth Code");

            // Hide loader
            loadingDiv.style.display = "none";
        })
    }
    // function validateForm() {
    //         var isValid = true;


    //         // Username validation
    //         var nameInput = $("#name");
    //         if (nameInput.val() === "") {
    //             isValid = false;
                
    //             showError(nameInput, "Username cannot be empty");
    //         }else{
    //             hideError(nameInput)
    //         }

           
    //         // Password validation
    //         var passwordInput = $("#password");
    //         if(passwordInput.val() === ""){
    //             isValid = false
    //             showError(passwordInput, "Password cannot be empty")
    //         }else{
    //             hideError(passwordInput)
    //         }

    //         return isValid;
    // }

    // // Function to show error message and highlight input
    // function showError(input, message) {
    //     var errorSpan = input.siblings(".text-danger");
    //     errorSpan.text(message);
    //     input.addClass("is-invalid");
    // }

    // // Function to hide error message and remove highlighting
    // function hideError(input) {
    //     var errorSpan = input.siblings(".text-danger");
    //     errorSpan.text("");
    //     input.removeClass("is-invalid");
    // }
</script>
{% endblock %}