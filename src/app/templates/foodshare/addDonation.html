{% extends "base.html" %}
{% block title %}FoodShareHub{% endblock %}
{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', path='assets/css/plugins/slider-range.css') }}" />
{% endblock %}

{% block content %}
<main class="main">
    <div class="page-header mt-30 mb-50">
        <div class="container">
            <div class="archive-header">
                <div class="row align-items-center">
                    <div class="col-xl-5">
                        <h1 class="mb-15">Add Donation Food Item</h1>
                        <div class="breadcrumb">
                            <a href="#" rel="nofollow"><i class="fi-rs-home mr-5"></i>Home</a>
                            <span></span> Food Sharing <span></span> Add Donation Food Item
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="container mb-30">
    <form id="process_add_listing_form" enctype="multipart/form-data">
        <div class="row">
            <div class="col-lg-4">
                <div class="card mb-4">
                    <div class="card-header">
                        <h4>Image</h4>
                    </div>
                    <div class="card-body">
                        <div class="input-upload">
                            <img class="preview-image" id="preview" src="{{ url_for('static', path='assets/imgs/theme/upload.svg') }}" alt="Preview Image"/>
                            <input class="form-control" type="file" id="image" name="image" accept="image/*" onchange="showImgPreview(this); updateBase64Value();" />
                            <span for="Upload" class="text-danger"></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <h4>Food Item Details</h4>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <label for="name" class="form-label">Food Item title</label>
                            <input type="text" placeholder="Type here" class="form-control" id="name" name="name" />
                            <span for="Upload" class="text-danger"></span>
                        </div>
                        <div class="mb-4">
                            <label class="form-label" for="description">Description</label>
                            <textarea placeholder="Type here" class="form-control" rows="12" style="height: 170px;" id="description" name="description" ></textarea>
                            <span for="Upload" class="text-danger"></span>
                        </div>
                        <div class="row">
                            <div class="mb-4">
                                <label class="form-label" for="category">Categories</label>
                                <select class="form-select" id="category" name="category">
                                    <option selected disabled>-- Please Select --</option>
                                    {% for category in categories %}
                                        <option value="{{ category.id }}">{{ category.name }}</option>
                                    {% endfor %}
                                </select>
                                <span for="Upload" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="mb-4">
                                <label class="form-label" for="expiry_date">Expiry Date:</label>
                                <div class="row gx-2">
                                    <span class="text-muted">Please ensure your food has at least a 7-day buffer before expiry.</span>
                                    <input type="date" id="expiry_date" class="form-control" name="expiry_date" />
                                </div>
                                <span for="Upload" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="mb-4">
                                <label class="form-label" for="postal_code">Pick Up Location</label>
                                <div class="row gx-2">
                                    <input placeholder="Please enter your postal code" type="text" class="form-control" id="postal_code" name="postal_code" />
                                </div>
                                <span for="Upload" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div> 
        </div>
        <div class="row">
            <div class="col-lg-12">
                <div class="form-group" style="text-align: right;">
                    <button type="submit" class="btn btn-md rounded font-sm hover-up">Submit</button>
                </div>
            </div>
        </div>
    </form>
    </div>
</main>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
    var _base64;

    document.addEventListener("DOMContentLoaded", function() {
        document.getElementById("process_add_listing_form").addEventListener("submit", function(event) {
            event.preventDefault();

            var isValid = validateForm();

            if (isValid) {
                // Start: Retrieve image input
                const fileInput = document.getElementById("image");
                const file = fileInput.files[0];
                // End: Retrieve image input

                // Start: Retrieve form data
                const formData = {
                    name: document.getElementById("name").value,
                    category_id: document.getElementById("category").value,
                    description: document.getElementById("description").value,
                    expiry_date: document.getElementById("expiry_date").value,
                    postal_code: document.getElementById("postal_code").value,
                    image: {
                        filename: fileInput.files[0].name,
                        content_type: fileInput.files[0].type,
                        size: fileInput.files[0].size,
                        base64: _base64
                    }
                };
                // End: Retrieve form data

                const loadingDiv = document.getElementById('loadingDiv');
                loadingDiv.style.display = '';

                // Start: Send form data using Fetch API
                fetch("/api/foodshare/addMyListing", {
                    method: "POST",
                    body: JSON.stringify(formData),
                    headers: {
                        "Content-Type": "application/json",
                    },
                })
                .then(response => response.json())
                .then(data => {
                    // Hide loader
                    loadingDiv.style.display = 'none';
                    // Extract the redirect URL from the JSON response
                    const redirectUrl = data.redirect_url;
                    // Redirect to the extracted URL
                    window.location.href = redirectUrl;
                })
                .catch(error => {
                    console.error("Error:", error);
                });
                // End: Send form data using Fetch API
            }
        });
    });

    // Function to convert file to base64
    function getBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(",")[1]);
            reader.onerror = error => reject(error);
        });
    }

    function updateBase64Value(){
        const fileInput = document.getElementById("image");
        const file = fileInput.files[0];
        getBase64(file)
            .then(base64Value => {
                _base64 = base64Value;
            })
            .catch(error => {
                console.error("Error converting file to base64:", error);
            });
    } 
    </script>

    <script>
        // Start: Function to show uploaded image preview
        function showImgPreview(input) {
            // Get the selected file
            var file = input.files[0];
            // Check if a file is selected
            if (file) {
                // Create a FileReader object
                var reader = new FileReader();

                // Set up the onload event for the FileReader
                reader.onload = function(e) {
                    // Perform actions to display the preview, for example, updating an <img> element
                    $('#preview').attr('src', e.target.result);
                };

                // Read the file content
                reader.readAsDataURL(file);
            }
        }
        // End: Function to show uploaded image preview
        
        // Start: Sets the minimum value allowed of the datepicker to current date
        $(document).ready(function() {
            $("#expiry_date").prop("min", new Date().toISOString().split("T")[0]);
        });
        // End: Sets the minimum value allowed of the datepicker to current date

        function validateForm() {
            var isValid = true;

            // Image validation
            var imageInput = $("input[name='image']");
            if (imageInput.val() === "") {
                isValid = false;
                showError(imageInput, "Please select an image");
            }

            // Food Item title validation
            var nameInput = $("#name");
            if (nameInput.val() === "") {
                isValid = false;
                showError(nameInput, "Please enter a Food Item title");
            }

            // Description validation
            var descriptionInput = $("#description");
            if (descriptionInput.val() === "") {
                isValid = false;
                showError(descriptionInput, "Please enter a description");
            }

            // Categories validation
            var categoryInput = $("#category");
            if (categoryInput.val() === null) {
                isValid = false;
                showError(categoryInput, "Please select a category");
            }

            // Expiry Date validation
            var expiryDateInput = $("#expiry_date");
            if (expiryDateInput.val() === "") {
                isValid = false;
                showError(expiryDateInput, "Please enter an expiry date");
            }

            // Pick Up Location validation
            var postalCodeInput = $("#postal_code");
            if (postalCodeInput.val() === "") {
                isValid = false;
                showError(postalCodeInput, "Please enter a postal code");
            }

            return isValid;
        }

        // Add blur event listener to each input field
        $("input, textarea, select").blur(function() {
            hideError($(this));
        });

        // Function to show error message and highlight input
        function showError(input, message) {
            var errorSpan = input.siblings(".text-danger");
            errorSpan.text(message);
            input.addClass("is-invalid");
        }

        // Function to hide error message and remove highlighting
        function hideError(input) {
            var errorSpan = input.siblings(".text-danger");
            errorSpan.text("");
            input.removeClass("is-invalid");
        }
    </script>
{% endblock %}
